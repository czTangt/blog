<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Windows - czTang</title><meta name=author content="czTang">
<meta name=description content="记录一下 Windows 逆向相关内容。
"><meta name=keywords content='reverse'><meta itemprop=name content="Windows"><meta itemprop=description content="记录一下 Windows 逆向相关内容。"><meta itemprop=datePublished content="2025-02-22T08:27:45+08:00"><meta itemprop=dateModified content="2025-02-22T08:27:45+08:00"><meta itemprop=wordCount content="15567"><meta itemprop=keywords content="Reverse"><meta property="og:url" content="https://czTangt.github.io/blog/posts/reverse/windows/"><meta property="og:site_name" content="czTang"><meta property="og:title" content="Windows"><meta property="og:description" content="记录一下 Windows 逆向相关内容。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-22T08:27:45+08:00"><meta property="article:modified_time" content="2025-02-22T08:27:45+08:00"><meta property="article:tag" content="Reverse"><meta name=twitter:card content="summary"><meta name=twitter:title content="Windows"><meta name=twitter:description content="记录一下 Windows 逆向相关内容。"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202410312135963.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://czTangt.github.io/blog/posts/reverse/windows/ title="Windows - czTang"><link rel=prev type=text/html href=https://czTangt.github.io/blog/posts/android/android-reverse/ title="Android Reverse"><link rel=stylesheet href=/blog/css/style.min.css><link rel=preload href=/blog/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/blog/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/blog/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/blog/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Windows","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/czTangt.github.io\/blog\/posts\/reverse\/windows\/"},"genre":"posts","keywords":"reverse","wordcount":15567,"url":"https:\/\/czTangt.github.io\/blog\/posts\/reverse\/windows\/","datePublished":"2025-02-22T08:27:45+08:00","dateModified":"2025-02-22T08:27:45+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"czTang"},"description":""}</script><script src=/blog/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/blog/ title=czTang><span class=header-title-pre><i class='fa fa-coffee'>&nbsp</i></span><span class=header-title-text>czTang</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/blog/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/blog/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/blog/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=/blog/about/><i class="fa-solid fa-user fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/blog/ title=czTang><span class=header-title-pre><i class='fa fa-coffee'>&nbsp</i></span><span class=header-title-text>czTang</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/blog/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/blog/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/blog/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=/blog/about/><i class="fa-solid fa-user fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集><div class="details collection-details open"><div class="details-summary collection-summary"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i>
<span class=collection-name title=合集>Reverse</span>
<span class=collection-count>5</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content collection-content"><nav><ul class=collection-list><li class=collection-item><a href=/blog/posts/android/elf/ title="ELF 解析">ELF 解析</a></li><li class=collection-item><a href=/blog/posts/reverse/algorithm/ title=逆向中的算法>逆向中的算法</a></li><li class=collection-item><a href=/blog/posts/android/unidbg/ title="Unidbg 记录">Unidbg 记录</a></li><li class=collection-item><a href=/blog/posts/android/android-reverse/ title="Android Reverse">Android Reverse</a></li><li class=collection-item><span class=active title=Windows>Windows</span></li></ul><div class=collection-nav-simple><a href=/blog/posts/android/android-reverse/ class=collection-nav-item rel=prev title="Android Reverse"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i></a><span class=text-secondary>5/5</span><i class="fa-solid fa-angle-right fa-fw collection-nav-item text-secondary" aria-hidden=true></i></div></nav></div></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Windows</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/czTangt title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img loading=lazy src=/blog/images/avatar.jpg alt=czTang data-title=czTang width=20 height=20 class=avatar style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'>&nbsp;czTang</a></span><span class=post-included-in>&nbsp;收录于 <a href=/blog/categories/reverse/ class=post-category title="分类 - Reverse"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Reverse</a> 和 <a href=/blog/collections/reverse/ class=post-collection title="合集 - Reverse"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> Reverse</a></span></div><div class=post-meta-line><span title="发布于 2025-02-22 08:27:45"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2025.2.22>2025.2.22</time></span>&nbsp;<span title="15567 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 15600 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 32 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#c--c>C & C++</a><ul><li><a href=#堆栈>堆栈</a></li><li><a href=#函数>函数</a><ul><li><a href=#函数概念>函数概念</a></li><li><a href=#函数分类>函数分类</a></li><li><a href=#调用约定>调用约定</a></li><li><a href=#函数传参>函数传参</a><ul><li><a href=#一般方式>一般方式</a></li></ul></li></ul></li><li><a href=#语句>语句</a><ul><li><a href=#ifelse>if……else</a></li><li><a href=#switch>switch</a></li><li><a href=#while>while</a></li><li><a href=#for>for</a></li></ul></li><li><a href=#数据>数据</a><ul><li><a href=#数据类型>数据类型</a></li><li><a href=#基本类型>基本类型</a><ul><li><a href=#相关类型>相关类型</a></li><li><a href=#类型转换>类型转换</a></li></ul></li><li><a href=#构造类型>构造类型</a><ul><li><a href=#数组类型>数组类型</a></li><li><a href=#结构体类型>结构体类型</a></li></ul></li><li><a href=#指针类型>指针类型</a><ul><li><a href=#基础知识>基础知识</a></li><li><a href=#运用>运用</a></li><li><a href=#结合>结合</a></li></ul></li></ul></li><li><a href=#内存>内存</a><ul><li><a href=#变量>变量</a><ul><li><a href=#全局变量>全局变量</a></li><li><a href=#局部变量>局部变量</a></li><li><a href=#总结>总结</a></li></ul></li><li><a href=#常量>常量</a></li></ul></li></ul></li><li><a href=#pe>PE</a><ul><li><a href=#汇总>汇总</a></li><li><a href=#基本概念>基本概念</a><ul><li><a href=#pe文件>PE文件</a></li><li><a href=#pe文件执行顺序>PE文件执行顺序</a></li><li><a href=#pe文件结构>PE文件结构</a></li><li><a href=#varva>VA&amp;RVA</a></li></ul></li><li><a href=#pe头>PE头</a><ul><li><a href=#dos头>DOS头</a><ul><li><a href=#image_dos_header>IMAGE_DOS_HEADER</a></li><li><a href=#dos存根>DOS存根</a></li></ul></li><li><a href=#nt头>NT头</a><ul><li><a href=#image_nt_headers>IMAGE_NT_HEADERS</a></li><li><a href=#image_file_header>IMAGE_FILE_HEADER</a></li><li><a href=#image_optional_header>IMAGE_OPTIONAL_HEADER</a></li></ul></li><li><a href=#节区头节表>节区头(节表)</a></li></ul></li><li><a href=#rva-to-raw>RVA to RAW</a></li><li><a href=#数据目录>数据目录</a><ul><li><a href=#导出表>导出表</a><ul><li><a href=#image_export_directory>IMAGE_EXPORT_DIRECTORY</a><ul><li><a href=#addressofnames>AddressOfNames</a></li><li><a href=#addressofnameordinals>AddressOfNameOrdinals</a></li><li><a href=#addressoffunctions>AddressOfFunctions</a></li></ul></li><li><a href=#导出方式>导出方式</a></li></ul></li><li><a href=#导入表>导入表</a><ul><li><a href=#image_import_descriptor>IMAGE_IMPORT_DESCRIPTOR</a><ul><li><a href=#originalfirstthunk>OriginalFirstThunk</a></li><li><a href=#name>Name</a></li><li><a href=#firstaddress>FirstAddress</a></li></ul></li><li><a href=#image_thunk_data><strong>IMAGE_THUNK_DATA</strong></a></li><li><a href=#image_import_by_name>IMAGE_IMPORT_BY_NAME</a></li><li><a href=#绑定导入表>绑定导入表</a></li></ul></li><li><a href=#重定位表>重定位表</a><ul><li><a href=#image_base_relocation>IMAGE_BASE_RELOCATION</a><ul><li><a href=#sizeofblock>SizeOfBlock</a></li><li><a href=#判断重定位表的数量>判断重定位表的数量</a></li><li><a href=#具体项>具体项</a></li></ul></li></ul></li><li><a href=#资源表>资源表</a><ul><li><a href=#image_resource_directory>IMAGE_RESOURCE_DIRECTORY</a></li><li><a href=#资源表的真正结构>资源表的真正结构</a><ul><li><a href=#第一层>第一层</a></li><li><a href=#第二层>第二层</a></li><li><a href=#第三层>第三层</a></li></ul></li></ul></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>记录一下 Windows 逆向相关内容。</p><h2 id=c--c class=heading-element><span>C & C++</span>
<a href=#c--c class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 id=堆栈 class=heading-element><span>堆栈</span>
<a href=#%e5%a0%86%e6%a0%88 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123987.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123987.png?size=small" data-sub-html="<h2>202210032045557</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123987.png alt=堆栈 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123987.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123987.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123987.png?size=large 2x" data-title=202210032045557 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>堆栈</figcaption></figure></p><ul><li>先进后出：ESP寄存器指向栈顶，每次 push 操作使 ESP 减 4</li><li>自动平衡：函数调用需保证入栈参数与出栈指令匹配</li></ul><h3 id=函数 class=heading-element><span>函数</span>
<a href=#%e5%87%bd%e6%95%b0 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h4 id=函数概念 class=heading-element><span>函数概念</span>
<a href=#%e5%87%bd%e6%95%b0%e6%a6%82%e5%bf%b5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>计算机函数是通过入口参数接收数据、经处理后通过出口返回结果的程序模块。入口参数通过寄存器或堆栈传递，返回值可通过寄存器或堆栈存储。</p><ul><li><p>汇编中的函数<figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123136.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123136.png?size=small" data-sub-html="<h2>202210032043850</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123136.png alt=函数 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123136.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123136.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123136.png?size=large 2x" data-title=202210032043850 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>函数</figcaption></figure></p></li><li><p>函数的入口，这里存储变量传递给函数除了存入堆栈中，也可以存入其余的寄存器中<figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123438.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123438.png?size=small" data-sub-html="<h2>202210032043993</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123438.png alt=函数入口 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123438.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123438.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123438.png?size=large 2x" data-title=202210032043993 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>函数入口</figcaption></figure></p></li><li><p>函数的出口，函数的计算结果除了放在寄存器中，还可以放到堆栈中<figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123896.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123896.png?size=small" data-sub-html="<h2>202210032044374</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123896.png alt=函数出口 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123896.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123896.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291123896.png?size=large 2x" data-title=202210032044374 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>函数出口</figcaption></figure></p></li></ul><h4 id=函数分类 class=heading-element><span>函数分类</span>
<a href=#%e5%87%bd%e6%95%b0%e5%88%86%e7%b1%bb class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><ul><li>裸函数，<a href="https://learn.microsoft.com/zh-cn/cpp/cpp/naked-cpp?view=msvc-170" target=_blank rel="external nofollow noopener noreferrer">naked (C++)</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>__declspec</span><span class=p>(</span><span class=kr>naked</span><span class=p>)</span> <span class=nf>Function</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 编译器不对裸函数进行任何处理，无法堆栈平衡，需要自己平衡堆栈
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>__asm</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><ul><li>无参数无返回值函数</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>__declspec</span><span class=p>(</span><span class=kr>naked</span><span class=p>)</span> <span class=nf>Function</span><span class=p>()</span>  					
</span></span><span class=line><span class=cl><span class=p>{</span>					
</span></span><span class=line><span class=cl>	<span class=kr>__asm</span>				
</span></span><span class=line><span class=cl>	<span class=p>{</span>	
</span></span><span class=line><span class=cl>  <span class=c1>// 提升堆栈，为函数执行提供空间
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>push</span> <span class=n>ebp</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>ebp</span><span class=p>,</span><span class=n>esp</span>			
</span></span><span class=line><span class=cl>		<span class=n>sub</span> <span class=n>esp</span><span class=p>,</span><span class=mh>0x40</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 保留现场
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>push</span> <span class=n>ebx</span>			
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>esi</span>			
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>edi</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 向分配空间填充数据
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>lea</span> <span class=n>edi</span><span class=p>,</span><span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>-</span><span class=mh>0x40</span><span class=p>]</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>eax</span><span class=p>,</span><span class=mh>0xCCCCCCCC</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>ecx</span><span class=p>,</span><span class=mh>0x10</span>			
</span></span><span class=line><span class=cl>		<span class=n>rep</span> <span class=n>stosd</span>			
</span></span><span class=line><span class=cl>	    <span class=cm>/*此处实现函数功能*/</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 恢复现场，将之前保留的寄存器值恢复
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>pop</span> <span class=n>edi</span>			
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>esi</span>
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>ebx</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 降低堆栈   
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>mov</span> <span class=n>esp</span><span class=p>,</span><span class=n>ebp</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 恢复栈底   
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>pop</span> <span class=n>ebp</span>			
</span></span><span class=line><span class=cl>  <span class=c1>// 函数执行完毕，返回到调用处			
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>ret</span>			
</span></span><span class=line><span class=cl>	<span class=p>}</span>				
</span></span><span class=line><span class=cl><span class=p>}</span>					
</span></span></code></pre></td></tr></table></div></div><ul><li>有参数有返回值函数</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__declspec</span><span class=p>(</span><span class=kr>naked</span><span class=p>)</span> <span class=nf>Function</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span><span class=kt>int</span> <span class=n>y</span><span class=p>)</span>  					
</span></span><span class=line><span class=cl><span class=p>{</span>					
</span></span><span class=line><span class=cl>	<span class=kr>__asm</span>				
</span></span><span class=line><span class=cl>	<span class=p>{</span>				
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>ebp</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>ebp</span><span class=p>,</span><span class=n>esp</span>			
</span></span><span class=line><span class=cl>		<span class=n>sub</span> <span class=n>esp</span><span class=p>,</span><span class=mh>0x40</span>			
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>ebx</span>			
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>esi</span>			
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>edi</span>			
</span></span><span class=line><span class=cl>		<span class=n>lea</span> <span class=n>edi</span><span class=p>,</span><span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>-</span><span class=mh>0x40</span><span class=p>]</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>eax</span><span class=p>,</span><span class=mh>0xCCCCCCCC</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>ecx</span><span class=p>,</span><span class=mh>0x10</span>			
</span></span><span class=line><span class=cl>		<span class=n>rep</span> <span class=n>stosd</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>	<span class=cm>/*函数功能实现*/</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>eax</span><span class=p>,</span><span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span>			
</span></span><span class=line><span class=cl>		<span class=n>add</span> <span class=n>eax</span><span class=p>,</span><span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>+</span><span class=mh>0xC</span><span class=p>]</span>			
</span></span><span class=line><span class=cl>					
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>edi</span>			
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>esi</span>			
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>ebx</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>esp</span><span class=p>,</span><span class=n>ebp</span>			
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>ebp</span>			
</span></span><span class=line><span class=cl>					
</span></span><span class=line><span class=cl>		<span class=n>ret</span>			
</span></span><span class=line><span class=cl>	<span class=p>}</span>				
</span></span><span class=line><span class=cl><span class=p>}</span>					
</span></span></code></pre></td></tr></table></div></div><ul><li>带局部变量的函数</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__declspec</span><span class=p>(</span><span class=kr>naked</span><span class=p>)</span> <span class=nf>Function</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span><span class=kt>int</span> <span class=n>y</span><span class=p>)</span>  					
</span></span><span class=line><span class=cl><span class=p>{</span>					
</span></span><span class=line><span class=cl>	<span class=kr>__asm</span>				
</span></span><span class=line><span class=cl>	<span class=p>{</span>				
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>ebp</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>ebp</span><span class=p>,</span><span class=n>esp</span>			
</span></span><span class=line><span class=cl>		<span class=n>sub</span> <span class=n>esp</span><span class=p>,</span><span class=mh>0x40</span>			
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>ebx</span>			
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>esi</span>			
</span></span><span class=line><span class=cl>		<span class=n>push</span> <span class=n>edi</span>			
</span></span><span class=line><span class=cl>		<span class=n>lea</span> <span class=n>edi</span><span class=p>,</span><span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>-</span><span class=mh>0x40</span><span class=p>]</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>eax</span><span class=p>,</span><span class=mh>0xCCCCCCCC</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>ecx</span><span class=p>,</span><span class=mh>0x10</span>			
</span></span><span class=line><span class=cl>		<span class=n>rep</span> <span class=n>stosd</span>
</span></span><span class=line><span class=cl>          
</span></span><span class=line><span class=cl>  <span class=cm>/*局部变量引入*/</span>
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>-</span><span class=mi>4</span><span class=p>],</span><span class=mi>2</span>		
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>-</span><span class=mi>8</span><span class=p>],</span><span class=mi>3</span>			
</span></span><span class=line><span class=cl>					
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>eax</span><span class=p>,</span><span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span>			
</span></span><span class=line><span class=cl>		<span class=n>add</span> <span class=n>eax</span><span class=p>,</span><span class=n>dword</span> <span class=n>ptr</span> <span class=nl>ds</span><span class=p>:[</span><span class=n>ebp</span><span class=o>+</span><span class=mh>0xC</span><span class=p>]</span>			
</span></span><span class=line><span class=cl>					
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>edi</span>			
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>esi</span>			
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>ebx</span>			
</span></span><span class=line><span class=cl>		<span class=n>mov</span> <span class=n>esp</span><span class=p>,</span><span class=n>ebp</span>			
</span></span><span class=line><span class=cl>		<span class=n>pop</span> <span class=n>ebp</span>			
</span></span><span class=line><span class=cl>					
</span></span><span class=line><span class=cl>		<span class=n>ret</span>			
</span></span><span class=line><span class=cl>	<span class=p>}</span>				
</span></span><span class=line><span class=cl><span class=p>}</span>					
</span></span></code></pre></td></tr></table></div></div><h4 id=调用约定 class=heading-element><span>调用约定</span>
<a href=#%e8%b0%83%e7%94%a8%e7%ba%a6%e5%ae%9a class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><table><thead><tr><th>调用约定</th><th>参数压栈顺序</th><th>平衡堆栈</th></tr></thead><tbody><tr><td>__cdecl</td><td>从右至左入栈</td><td>调用者清理栈(外平栈)</td></tr><tr><td>__stdcall</td><td>从右至左入栈</td><td>自身清理栈(内平栈)</td></tr><tr><td>__fastcall</td><td>ECX/EDX传送前两个，剩下:从右至左入栈</td><td>自身清理栈(内平栈)</td></tr></tbody></table><div class="details admonition info open disabled"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-circle-info" aria-hidden=true></i>信息</div><div class=details-content><div class=admonition-content><p><code>__fastcall</code> 的参数只有大于两个才需要內平栈，两个参数直接传递寄存器，不需要平衡堆栈</p></div></div></div><h4 id=函数传参 class=heading-element><span>函数传参</span>
<a href=#%e5%87%bd%e6%95%b0%e4%bc%a0%e5%8f%82 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 id=一般方式 class=heading-element><span>一般方式</span>
<a href=#%e4%b8%80%e8%88%ac%e6%96%b9%e5%bc%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><ul><li>观察调用处的代码</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>push</span>        <span class=mi>3</span>				
</span></span><span class=line><span class=cl><span class=nf>push</span>        <span class=mi>2</span>				
</span></span><span class=line><span class=cl><span class=nf>push</span>        <span class=mi>1</span>				
</span></span><span class=line><span class=cl><span class=nf>call</span>        <span class=mi>0040100</span><span class=nv>f</span></span></span></code></pre></td></tr></table></div></div><ul><li>找到平衡堆栈的代码（外平栈）或者函数内部（內平栈）继续论证</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>call</span>        <span class=mi>0040100</span><span class=nv>f</span>				
</span></span><span class=line><span class=cl><span class=nf>add</span>         <span class=nb>esp</span><span class=p>,</span><span class=mh>0Ch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>ret</span> <span class=mi>4</span><span class=o>/</span><span class=mi>8</span><span class=o>/</span><span class=mh>0xC</span><span class=o>/</span><span class=mh>0x10</span></span></span></code></pre></td></tr></table></div></div><ul><li>将二者结合，确定参数个数</li></ul><p>由此可以知道函数传参的确认方法，首先不考虑 ebp、esp，然后只找给别人赋值的寄存器，例如 eax/ecx/edx/ebx/esi/edi，找到以后追查其来源，如果该寄存器中的值不是在 <strong>函数内存赋值</strong> 的，那一定是传进来的参数，最后可以通过下面公署获得参数数量：</p><ul><li><code>reg + ret 4 = num of args</code></li><li><code>reg + [ebp+8] + [ebp+0x] = num of args</code></li></ul><h3 id=语句 class=heading-element><span>语句</span>
<a href=#%e8%af%ad%e5%8f%a5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h4 id=ifelse class=heading-element><span>if……else</span>
<a href=#ifelse class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>反汇编语句与if语句含义相反，即若 <code>if(x>=1)</code>，则反汇编中表达 <code>x&lt;1</code> 时跳转，否则继续顺序执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Fun</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>x</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>x</span><span class=o>&gt;=</span><span class=mi>3</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291124190.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291124190.png?size=small" data-sub-html="<h2>202212241152274</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291124190.png alt=if……else语句 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291124190.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291124190.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291124190.png?size=large 2x" data-title=202212241152274 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>if……else语句</figcaption></figure></p><h4 id=switch class=heading-element><span>switch</span>
<a href=#switch class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>这里分支小于 4 或者数据无规律时，用 switch 无意义，会生成类似 if……else 的反汇编结构；而 Switch 语句中数值相近时，会自动生成大表（连续数值中多个不存在时，会生成小表），详细可以看看 <a href=https://www.cnblogs.com/Reverse-xiaoyu/p/11711393.html target=_blank rel="external nofollow noopener noreferrer">switch&mldr;case&mldr;语句分析(大表跟小表何时产生)</a>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Fun</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;A&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;B&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;C&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>4</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;D&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>9</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;Z&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;Error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125123.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125123.png?size=small" data-sub-html="<h2>202212241120544</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125123.png alt=Switch语句中的大表 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125123.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125123.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125123.png?size=large 2x" data-title=202212241120544 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>Switch语句中的大表</figcaption></figure></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Fun</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>101</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;A&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>108</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;X&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>109</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;Y&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>110</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;Z&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=s>&#34;Error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125399.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125399.png?size=small" data-sub-html="<h2>202212241139348</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125399.png alt=Switch语句中的小表 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125399.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125399.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125399.png?size=large 2x" data-title=202212241139348 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>Switch语句中的小表</figcaption></figure></p><h4 id=while class=heading-element><span>while</span>
<a href=#while class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><ul><li>根据条件跳转指令所跳转到的地址，可以得到循环语句块的结束地址</li><li>根据 jmp 指令所跳转到的地址，可以得到循环语句块的起始地址</li><li>在还原 while 比较时，条件跳转的逻辑与源码相反</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Fun</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=n>x</span> <span class=o>&lt;</span> <span class=n>y</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>x</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125717.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125717.png?size=small" data-sub-html="<h2>202212241157555</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125717.png alt=while语句 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125717.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125717.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125717.png?size=large 2x" data-title=202212241157555 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>while语句</figcaption></figure></p><h4 id=for class=heading-element><span>for</span>
<a href=#for class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><ul><li>第一个 jmp 指令之前为赋初值部分</li><li>第一个 jmp 指令所跳转的地址为循环条件判定部分起始</li><li>判断条件后面的跳转指令条件成立时跳转的循环体外面</li><li>条件判断跳转指令所指向的地址上面有一个 jmp，jmp 地址为表达式3的起始位置</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Fun</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span><span class=kt>int</span> <span class=n>y</span><span class=p>){</span>			
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=n>x</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=n>y</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>		
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>i</span><span class=p>);</span>	
</span></span><span class=line><span class=cl>	<span class=p>}</span>		
</span></span><span class=line><span class=cl><span class=p>}</span>			
</span></span></code></pre></td></tr></table></div></div><p><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125748.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125748.png?size=small" data-sub-html><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125748.png alt=202212241200812 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125748.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125748.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125748.png?size=large 2x" data-title=202212241200812 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><center><strong>for语句</strong></center><h3 id=数据 class=heading-element><span>数据</span>
<a href=#%e6%95%b0%e6%8d%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h4 id=数据类型 class=heading-element><span>数据类型</span>
<a href=#%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><strong>基本类型</strong></p><ul><li>整数类型</li><li>浮点类型</li></ul><p><strong>构造类型</strong></p><ul><li>数组类型</li><li>结构体类型</li><li>共用体(联合)类型</li></ul><p><strong>指针类型</strong></p><p><strong>空类型(void)</strong></p><ul><li>数据类型三个要素<ul><li>存储数据的宽度</li><li>存储数据的格式</li><li>作用范围(作用域)</li></ul></li></ul><h4 id=基本类型 class=heading-element><span>基本类型</span>
<a href=#%e5%9f%ba%e6%9c%ac%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 id=相关类型 class=heading-element><span>相关类型</span>
<a href=#%e7%9b%b8%e5%85%b3%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><table><thead><tr><th>数据类型</th><th>长度(bit)</th><th>长度(字节)</th><th>汇编中表示</th></tr></thead><tbody><tr><td>char</td><td>8BIT</td><td>1字节</td><td>BYTE</td></tr><tr><td>short</td><td>16BIT</td><td>2字节</td><td>WORD</td></tr><tr><td>int</td><td>32BIT</td><td>4字节</td><td>DWORD</td></tr><tr><td>long</td><td>32BIT</td><td>4字节</td><td></td></tr></tbody></table><p>上述类型划分为 <strong>有符号(signed)</strong> 与 <strong>无符号(unsigned)</strong>，其在计算机中存储方式相同，但是根据需求认定为不同的数值。而 <strong>float</strong> 和 <strong>double</strong> 在存储方式上遵从 <strong>IEEE</strong> 规范。</p><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125885.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125885.png?size=small" data-sub-html="<h2>202212222043652</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125885.png alt=float的存储方式 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125885.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125885.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125885.png?size=large 2x" data-title=202212222043652 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>float的存储方式</figcaption></figure></p><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125982.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125982.png?size=small" data-sub-html="<h2>202212222044090</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125982.png alt=double的存储方式 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125982.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125982.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291125982.png?size=large 2x" data-title=202212222044090 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>double的存储方式</figcaption></figure></p><p>将一个 float 型转化为内存存储格式：</p><ul><li>先将这个实数的绝对值化为二进制格式</li><li>将这个二进制格式实数的小数点左移或右移 n 位，直到小数点移动到第一个有效数字(1)的右边</li><li>从小数点右边第一位开始数出二十三位数字放入第 22 到第 0 位</li><li>将移动位数 +127 并转化为二进制放入第 30 到 23 位(例如:右移 3 位，即 127+(-3) = 124)</li><li>若原本数字为负数，则在符号位填入 “1”；否则，填入 “0”</li></ul><h5 id=类型转换 class=heading-element><span>类型转换</span>
<a href=#%e7%b1%bb%e5%9e%8b%e8%bd%ac%e6%8d%a2 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><ul><li><p><code>MOVSX</code>先符号扩展，再传送，适用于有符号类型转换</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>mov</span> <span class=nb>al</span><span class=p>,</span><span class=mh>0xFF</span>
</span></span><span class=line><span class=cl><span class=nf>movsx</span> <span class=nb>cx</span><span class=p>,</span><span class=nb>al</span>
</span></span><span class=line><span class=cl><span class=c1>;此时cx == 0XFFFF(看0xFF的第一位是什么，FF == 1111 1111，首位是1，扩展8个1)</span></span></span></code></pre></td></tr></table></div></div></li><li><p><code>MOVZX</code>先零扩展，再传送，适用于无符号类型转换</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=line><span class=cl><span class=nf>mov</span> <span class=nb>al</span><span class=p>,</span><span class=mh>0xFF</span>
</span></span><span class=line><span class=cl><span class=nf>movsx</span> <span class=nb>cx</span><span class=p>,</span><span class=nb>al</span>
</span></span><span class=line><span class=cl><span class=c1>;此时cx == 0XFF(直接在FF前面补8个0)</span></span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=构造类型 class=heading-element><span>构造类型</span>
<a href=#%e6%9e%84%e9%80%a0%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 id=数组类型 class=heading-element><span>数组类型</span>
<a href=#%e6%95%b0%e7%bb%84%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>一组相同类型的变量，为了方便读写，采用另外一种表示形式。其在声明的时候，必须用常量来指明长度，不能使用变量（<strong>常量是因为在编译的时候，编译器就要知道开辟的缓冲区的大小，所以必须是常量</strong>）。数组在使用时，可以通过变量来定位数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//例如：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>arr</span><span class=p>[</span><span class=n>m</span><span class=p>][</span><span class=n>n</span><span class=p>][</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=p>{{},{}</span><span class=err>……</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//寻找arr[3][2][1]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>在编译器中，寻找方式为arr[3*n+2*k+1]。
</span></span></span><span class=line><span class=cl><span class=cm>一维数组与多维数组的本质没有区别，arr[m*n*k]与arr[m][n][k]开辟相同
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>  
</span></span></code></pre></td></tr></table></div></div><h5 id=结构体类型 class=heading-element><span>结构体类型</span>
<a href=#%e7%bb%93%e6%9e%84%e4%bd%93%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>本质是大量数据的内存复制，传参时可以视为数组。</p><h4 id=指针类型 class=heading-element><span>指针类型</span>
<a href=#%e6%8c%87%e9%92%88%e7%b1%bb%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 id=基础知识 class=heading-element><span>基础知识</span>
<a href=#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><ol><li>格式：<em><em>数据类型</em> 变量名</em>*；</li><li>宽度为4字节， * 可以是任意数量；</li><li>加减操作（+/-/++/&ndash;）都是 <strong>以数据类型的宽度为标准</strong> 进行增加或减少，例如：char 为 1，int 为 4。即加减增加的是去掉一个 * 之后的数据宽度，若是 char **，增加的就是 4 字节；</li><li><strong>两种类型相互加减</strong>：<ul><li>两个类型相同的带 * 类型的变量可以进行减法操作，减完后的数据类型是去掉 * 的数据类型</li><li>相减的结果要除以去掉一个 * 的数据类型的宽度</li></ul></li></ol><h5 id=运用 class=heading-element><span>运用</span>
<a href=#%e8%bf%90%e7%94%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><ol><li><code>&</code> 是地址符，类型是其后面的类型加一个 * ，任何变量都可以使用&来获取地址，但不能用在常量上;</li><li><strong>带 * 类型的变量</strong>，可以通过在其变量前加 * 来获取 <strong>其指向内存中存储的值</strong>，即在带 * 类型的变量前面加 *，类型是其原来的类型减去一个 * 。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span><span class=n>x</span>	<span class=c1>//(int*)
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl><span class=kt>int</span><span class=o>*</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>*</span><span class=n>y</span>	<span class=c1>//(int)
</span></span></span></code></pre></td></tr></table></div></div><h5 id=结合 class=heading-element><span>结合</span>
<a href=#%e7%bb%93%e5%90%88 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><ul><li>指针函数：返回值为指针的函数&mdash;-函数</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=nf>strcpy</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span><span class=kt>char</span><span class=o>*</span> <span class=n>src</span><span class=p>)</span>			
</span></span><span class=line><span class=cl><span class=p>{</span>			
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>((</span><span class=o>*</span><span class=p>(</span><span class=n>dest</span><span class=o>++</span><span class=p>)</span><span class=o>=*</span><span class=p>(</span><span class=n>src</span><span class=o>++</span><span class=p>))</span><span class=o>!=</span><span class=mi>0</span><span class=p>);</span>		
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>dest</span><span class=p>;</span>		
</span></span><span class=line><span class=cl><span class=p>}</span>							
</span></span></code></pre></td></tr></table></div></div><ul><li>函数指针：声明&mdash;-返回类型(*函数名)(参数表)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//声明
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>pFun</span><span class=p>)(</span><span class=kt>int</span><span class=p>,</span><span class=kt>int</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//赋值
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>pFun</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>int</span><span class=p>,</span><span class=kt>int</span><span class=p>))</span><span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>pFun</span> <span class=o>=</span> <span class=err>函数名</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li>指针数组：数组的类型是指针类型&mdash;-数组</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=n>arr</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span></span></span></code></pre></td></tr></table></div></div><ul><li>数组指针：本质是指针，<code>不必指向数组</code>，只是使用定义的数组的宽度</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//变量名px，数据类型 int[5]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span><span class=p>(</span><span class=o>*</span><span class=n>px</span><span class=p>)[</span><span class=mi>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//例子
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>arr</span><span class=p>[</span><span class=mi>15</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>6</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>int</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>)[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>(</span><span class=o>*</span><span class=p>)</span> <span class=p>[</span><span class=mi>2</span><span class=p>])</span><span class=n>arr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d %d %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>p</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=p>),</span> <span class=o>*</span><span class=p>(</span><span class=n>p</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>1</span><span class=p>],</span> <span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]);</span></span></span></code></pre></td></tr></table></div></div><ul><li>结构体指针：结构体</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>Struct</span> <span class=n>Arg</span>	
</span></span><span class=line><span class=cl><span class=p>{</span>	
</span></span><span class=line><span class=cl>   <span class=kt>int</span> <span class=n>a</span><span class=p>;</span>	
</span></span><span class=line><span class=cl>   <span class=kt>int</span> <span class=n>b</span><span class=p>;</span>	
</span></span><span class=line><span class=cl>   <span class=kt>int</span> <span class=n>c</span><span class=p>;</span>	
</span></span><span class=line><span class=cl><span class=p>}</span>	
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>function</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=c1>//创建结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Student</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//声明结构体指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Student</span><span class=o>*</span> <span class=n>ps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//为结构体指针赋值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ps</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//通过指针读取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>ps</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//还可以使用其他指针类型对结构体指针进行赋值，此时结构体指针可以利用自己的构造遍历未知空间数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Arg</span><span class=o>*</span> <span class=n>px</span> <span class=o>=</span> <span class=p>(</span><span class=n>Arg</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d %d %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>px</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>,</span><span class=n>px</span><span class=o>-&gt;</span><span class=n>b</span><span class=p>,</span><span class=n>px</span><span class=o>-&gt;</span><span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=内存 class=heading-element><span>内存</span>
<a href=#%e5%86%85%e5%ad%98 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126765.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126765.png?size=small" data-sub-html="<h2>202212222123177</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126765.png alt=汇编布局 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126765.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126765.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126765.png?size=large 2x" data-title=202212222123177 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>汇编布局</figcaption></figure></p><h4 id=变量 class=heading-element><span>变量</span>
<a href=#%e5%8f%98%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 id=全局变量 class=heading-element><span>全局变量</span>
<a href=#%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>g_n</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>Function</span><span class=p>()</span>			
</span></span><span class=line><span class=cl><span class=p>{</span>			
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>		
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>		
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>g_n</span><span class=o>+</span><span class=n>x</span><span class=o>+</span><span class=n>y</span><span class=p>;</span>		
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><ol><li>全局变量在程序编译完成后地址就已经确定下来了，只要程序启动，全局变量就已经存在了，启动后里面是否有值取决于声明时是否给定了初始值，如果没有，默认为0</li><li>全局变量的值可以被所有函数所修改，里面存储的是最后一次修改的值</li><li>全局变量所占内存会一直存在，知道整个进程结束</li><li>全局变量的反汇编识别，通过寄存器的宽度，或者 byte/word/dword 来判断全局变量的宽度：<code>MOV REG,byte/word/dword ptr ds:[0x12345678]</code></li><li><strong>全局变量就是所谓的基址</strong></li></ol><h5 id=局部变量 class=heading-element><span>局部变量</span>
<a href=#%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>Function</span><span class=p>()</span>			
</span></span><span class=line><span class=cl><span class=p>{</span>			
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>		
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>		
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>g_n</span><span class=o>+</span><span class=n>x</span><span class=o>+</span><span class=n>y</span><span class=p>;</span>		
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><ol><li>局部变量在程序编译完成后并没有分配固定的地址</li><li>在所属的方法没有被调用时，局部变量并不会分配内存地址，只有当所属的程序被调用了，才会在堆栈中分配内存</li><li>当局部变量所属的方法执行完毕后，局部变量所占用的内存将变成垃圾数据。局部变量消失</li><li>局部变量只能在方法内部使用，函数A无法使用函数B的局部变量</li><li>局部变量的反汇编识别，<code>[ebp-4]</code>，<code>[ebp-8]</code>，<code>[ebp-0xC]</code>等</li></ol><h5 id=总结 class=heading-element><span>总结</span>
<a href=#%e6%80%bb%e7%bb%93 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>这里需要注意，这是针对普通的函数所写出的地址对应，即 <code>push edp……</code> 等操作，如果是个裸函数，或自定义函数，则不再适配</p><ul><li>全局变量：一个固定的地址，类似 <code>byte/word/dword ptr ds:[0x12345678]</code> 类型</li><li>局部变量：<code>[ebp-x]</code>，类似 <code>[ebp-4]</code>，<code>[ebp-8]</code>，<code>[ebp-0xC]</code> 等</li><li>传入参数：<code>[ebp+x]</code>，类似 <code>[ebp+8]</code>，<code>[ebp+0xC]</code> 等(x≠4)</li><li>特殊：<ul><li><code>[ebp]</code> 存储的是ebp在被push前的数值</li><li><code>[ebp+4]</code> 存储是call返回时的EIP指向的地址</li></ul></li></ul><h4 id=常量 class=heading-element><span>常量</span>
<a href=#%e5%b8%b8%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//样例一
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span><span class=o>*</span> <span class=n>x</span> <span class=o>=</span> <span class=s>&#34;china&#34;</span><span class=p>;</span>			
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>y</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;china&#34;</span><span class=p>;</span>			
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Function</span><span class=p>()</span>			
</span></span><span class=line><span class=cl><span class=p>{</span>			
</span></span><span class=line><span class=cl>    <span class=c1>//报错，其中&#34;china&#34;存储在常量区，不能对其进行修改，但是可以修改x的指向(地址)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=n>x</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;A&#39;</span><span class=p>;</span>		
</span></span><span class=line><span class=cl>	<span class=c1>//正常，y[]存储的字符串存储在全局变量区域(从常量区复制过来的)，可以进行修改
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>y</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;A&#39;</span><span class=p>;</span>		
</span></span><span class=line><span class=cl><span class=p>}</span>		
</span></span><span class=line><span class=cl><span class=c1>//样例二
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>Function</span><span class=p>()</span>			
</span></span><span class=line><span class=cl><span class=p>{</span>			
</span></span><span class=line><span class=cl>	<span class=kt>char</span><span class=o>*</span> <span class=n>x</span> <span class=o>=</span> <span class=s>&#34;china&#34;</span><span class=p>;</span>			
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>y</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;china&#34;</span><span class=p>;</span>		
</span></span><span class=line><span class=cl>	<span class=c1>//报错		
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=n>x</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;A&#39;</span><span class=p>;</span>		
</span></span><span class=line><span class=cl>	<span class=c1>//正常
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>y</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;A&#39;</span><span class=p>;</span>		
</span></span><span class=line><span class=cl><span class=p>}</span>	
</span></span></code></pre></td></tr></table></div></div><p>总结：</p><ul><li>&ldquo;china"字符串存储在常量区内，不可以进行修改</li><li><code>*(x+1)</code> 中的x指向的是"china"在常量区的地址，直接对x进行修改就是修改常量区的数据，报错</li><li><code>y[1]</code> 中的数组在堆栈中开辟，常量区中的"china"被复制到了eax等寄存器中，成为了变量，修改y就是修改堆栈中的变量部分，所以正常运行。即y[1]不修改常量区内容，而是复制到变量区再进行修改</li></ul><h2 id=pe class=heading-element><span>PE</span>
<a href=#pe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 id=汇总 class=heading-element><span>汇总</span>
<a href=#%e6%b1%87%e6%80%bb class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>分析PE格式工具 <a href=https://blog.csdn.net/u013908944/article/details/103356615 target=_blank rel="external nofollow noopener noreferrer">PETool</a></li><li><a href=https://blog.csdn.net/freeking101/article/details/102752048 target=_blank rel="external nofollow noopener noreferrer">PE文件结构详解</a></li><li><a href=https://blog.csdn.net/weixin_43655282/article/details/104291312 target=_blank rel="external nofollow noopener noreferrer">PE文件结构详解精华</a></li></ul><h3 id=基本概念 class=heading-element><span>基本概念</span>
<a href=#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h4 id=pe文件 class=heading-element><span>PE文件</span>
<a href=#pe%e6%96%87%e4%bb%b6 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>PE（Portable Execute）文件是Windows下可执行文件的总称，常见的有 <strong>DLL，EXE，OCX，SYS</strong> 等。它是微软在 UNIX 平台的 COFF （通用对象文件格式） 基础上制作而成。<strong>最初设计用来提高程序在不同操作系统上的移植性，但实际上这种文件格式仅用在 Windows 系列操作系统下</strong>。<strong>PE文件是指 32 位可执行文件，也称为PE32。64位的可执行文件称为 PE+ 或 PE32+，是PE（PE32）的一种扩展形式（请注意不是PE64）</strong>。早期磁盘空间不足，PE磁盘文件与内存映像结构不同，磁盘每 200h 为一节，内存则是 1000h 为一节。后来随之发展，二者相一致<figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126138.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126138.png?size=small" data-sub-html="<h2>202301121246317</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126138.png alt=映射关系 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126138.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126138.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291126138.png?size=large 2x" data-title=202301121246317 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>映射关系</figcaption></figure></p><p>PE文件的结构一般来说如下图所示：从起始位置开始依次是 <strong>DOS头</strong>，<strong>NT头</strong>，<strong>节表</strong> 以及 <strong>具体的节</strong><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127620.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127620.png?size=small" data-sub-html="<h2>202302250820743</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127620.png alt=PE结构 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127620.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127620.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127620.png?size=large 2x" data-title=202302250820743 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>PE结构</figcaption></figure></p><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127571.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127571.png?size=small" data-sub-html="<h2>202301121155957</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127571.png alt=PE结构 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127571.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127571.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291127571.png?size=large 2x" data-title=202301121155957 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>PE结构</figcaption></figure></p><h4 id=pe文件执行顺序 class=heading-element><span>PE文件执行顺序</span>
<a href=#pe%e6%96%87%e4%bb%b6%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><ol><li>当一个 PE 文件被执行时，<strong>PE 装载器</strong> 首先检查 DOS header 里的 PE header 的偏移量。如果找到，则直接跳转到 PE header 的位置。</li><li>当 <strong>PE 装载器</strong> 跳转到 PE header 后，第二步要做的就是检查 PE header 是否有效。如果该 PE header 有效，就跳转到 PE header 的尾部。</li><li>紧跟 PE header 尾部的是节表。PE装载器执行完第二步后开始读取节表中的节段信息，并采用文件映射的方法将这些节段映射到内存，<strong>同时附上节表里指定节段的读写属性</strong>。 这里 <strong>文件映射</strong> 是指在执行一个PE文件的时候，Windows 并不在一开始就将整个文件读入内存，而是采用与内存映射的机制，也就是说，<strong>Windows 装载器在装载的时候仅仅建立好虚拟地址和PE文件之间的映射关系，只有真正执行到某个内存页中的指令或者访问某一页中的数据时，这个页面才会被从磁盘提交到物理内存</strong>，这种机制使文件装入的速度和文件大小没有太大的关系</li><li>PE 文件映射入内存后，PE 装载器将继续处理 PE 文件中类似 import table (输入表)的逻辑部分。</li></ol><h4 id=pe文件结构 class=heading-element><span>PE文件结构</span>
<a href=#pe%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><ol><li><strong>DOS头</strong> 是用来兼容 MS-DOS 操作系统的，目的是当这个文件在 MS-DOS 上运行时提示一段文字，大部分情况下是：This program cannot be run in DOS mode. 同时指明 NT 头在文件中的位置。</li><li><strong>NT头</strong> 包含 windows PE 文件的主要信息，其中包括一个 <strong>&lsquo;PE&rsquo; 字样的签名</strong>，**PE文件头(IMAGE_FILE_HEADER)**和 <strong>PE可选头(IMAGE_OPTIONAL_HEADER32)。</strong></li><li><strong>节表</strong>：是 PE 文件后续节的描述，windows 根据节表的描述加载每个节。</li><li><strong>节</strong>：每个节实际上是一个容器，可以包含代码、数据等等，每个节可以有独立的内存权限，比如代码节默认有读/执行权限，节的名字和数量可以自己定义，未必是上图中的三个。</li></ol><h4 id=varva class=heading-element><span>VA&amp;RVA</span>
<a href=#varva class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>VA指的是进程虚拟内存的 <strong>绝对地址</strong>，RVA指从某个基准位置开始的 <strong>相对地址</strong>。VA与RVA满足：
$$
RVA + ImageBase = VA
$$
PE头内部大多以RVA形式存在。32位Windows OS中，各进程分配有 4GB 的虚拟内存，因此进程中VA值的范围是0000 0000 ~ FFFF FFFF。</p><h3 id=pe头 class=heading-element><span>PE头</span>
<a href=#pe%e5%a4%b4 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>win采用小端序存储，查看十六进制时需要从右往左。32位PE头大小：</p><ul><li>DOS：<code>40h</code></li><li>NT：<code>4h + 14h(FILE) + E0h(Optional)</code></li></ul><h4 id=dos头 class=heading-element><span>DOS头</span>
<a href=#dos%e5%a4%b4 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 id=image_dos_header class=heading-element><span>IMAGE_DOS_HEADER</span>
<a href=#image_dos_header class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>所有的PE文件都是以一个 <strong>64(40h)字节</strong> （一个字节8位）的 <strong>DOS头</strong>（MZ文件头）开始。这个 DOS 头只是为了兼容早期的 DOS 操作系统。该结构体中需要掌握的字段只有 2 个，分别是第一个字段 <code>e_magic</code> 和最后一个字段 <code>e_lfanew</code> 字段</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DOS_HEADER</span> <span class=p>{</span>　<span class=c1>// DOS .EXE header
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_magic</span><span class=p>;</span>　　　　<span class=c1>// Magic number
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_cblp</span><span class=p>;</span>　　　　 <span class=c1>// Bytes on last page of file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_cp</span><span class=p>;</span>　　　　　 <span class=c1>// Pages in file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_crlc</span><span class=p>;</span>　　　　 <span class=c1>// Relocations
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_cparhdr</span><span class=p>;</span>　　　<span class=c1>// Size of header in paragraphs
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_minalloc</span><span class=p>;</span>　　 <span class=c1>// Minimum extra paragraphs needed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_maxalloc</span><span class=p>;</span>　　 <span class=c1>// Maximum extra paragraphs needed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_ss</span><span class=p>;</span>　　　　　　<span class=c1>// Initial (relative) SS value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_sp</span><span class=p>;</span>　　　　　　<span class=c1>// Initial SP value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_csum</span><span class=p>;</span>　　　　　<span class=c1>// ChecksumWORD e_ip;Initial IP valueWORD　e_cs;Initial (relative) CS value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_lfarlc</span><span class=p>;</span>　　　　<span class=c1>// File address of relocation table
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_ovno</span><span class=p>;</span>　　　　　<span class=c1>// Overlay number
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_res</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>　　　　<span class=c1>// Reserved words
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_oemid</span><span class=p>;</span>　　　　 <span class=c1>// OEM identifier (for e_oeminfo)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_oeminfo</span><span class=p>;</span>　　　 <span class=c1>// OEM information; e_oemid specific
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>WORD</span>　<span class=n>e_res2</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>　　　<span class=c1>// Reserved words
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>LONG</span>　<span class=n>e_lfanew</span><span class=p>;</span>　　　　<span class=c1>// File address of new exe header
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_DOS_HEADER</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DOS_HEADER</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p><code>e_magic</code> 字段：DOS 可执行文件的标识符(DOS签名)，占用2字节。该位置保存着的字符是“MZ”。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define IMAGE_DOS_SIGNATURE　　　　</span><span class=c1>//0x5A4D　MZ
</span></span></span></code></pre></td></tr></table></div></div><p><code>e_lfanew</code> 字段：只是NT头的偏移&mdash;-PE头相对于文件的偏移，定位PE文件。它用于 <strong>定位PE文件头开始位置</strong>，也可用于 <strong>PE文件合法性检测</strong>。</p><h5 id=dos存根 class=heading-element><span>DOS存根</span>
<a href=#dos%e5%ad%98%e6%a0%b9 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>DOS存根(stub)在DOS头下方，是个可选项，且大小不固定（即使没有DOS存根，文件也能正常运行）。</p><h4 id=nt头 class=heading-element><span>NT头</span>
<a href=#nt%e5%a4%b4 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 id=image_nt_headers class=heading-element><span>IMAGE_NT_HEADERS</span>
<a href=#image_nt_headers class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><strong>NT头：PE标识</strong>结构体的大小为<strong>F8h</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_NT_HEADERS</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span> <span class=n>Signature</span><span class=p>;</span>                         
</span></span><span class=line><span class=cl>      <span class=c1>//该结构体中的Signature就是PE标识符,标识该文件是否是PE文件。4字节，即 50 45 0000 -&gt; 00 00 45 50 -&gt; PE
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>IMAGE_FILE_HEADER</span> <span class=n>FileHeader</span><span class=p>;</span>             
</span></span><span class=line><span class=cl>      <span class=c1>// IMAGE_FILE_HEADER是PE文件头
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>IMAGE_OPTIONAL_HEADER32</span> <span class=n>OptionalHeader</span><span class=p>;</span>   <span class=c1>// 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_NT_HEADERS32</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_NT_HEADERS32</span><span class=p>;</span>  
</span></span></code></pre></td></tr></table></div></div><ul><li><code>Signature(签名)</code>字段：类似于 DOS头中的 e_magic，其高16位是0，低16是0x4550，用字符表示是 “PE”。</li><li><code>File Header</code>：文件头结构体</li><li><code>Optional Header</code>：可选头结构体</li></ul><p>为简单分析，此时PE头（file与optional）只看32位，64位的暂且不看</p><h5 id=image_file_header class=heading-element><span>IMAGE_FILE_HEADER</span>
<a href=#image_file_header class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><strong>NT头：文件头</strong>，共 <strong>14h</strong> 个字节，其中需要掌握的字段有5个（注意NT头有个4字节的Signature）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_FILE_HEADER</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>Machine</span><span class=p>;</span>              
</span></span><span class=line><span class=cl>        <span class=c1>// 每个CPU拥有唯一的Machine码 -&gt; 4C 01 -&gt; PE -&gt; 兼容32位Intel X86芯片
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>NumberOfSections</span><span class=p>;</span>     
</span></span><span class=line><span class=cl>        <span class=c1>// 指文件中存在的节段(又称节区)数量，也就是节表中的项数 -&gt; 00 04 -&gt; 4
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 该值一定要大于0，且当定义的节段数与实际不符时，将发生运行错误。
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>TimeDateStamp</span><span class=p>;</span>         
</span></span><span class=line><span class=cl>        <span class=c1>// PE文件的创建时间，一般有连接器填写 -&gt; 38 D1 29 1E
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>PointerToSymbolTable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// COFF文件符号表在文件中的偏移 -&gt; 00 00 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>NumberOfSymbols</span><span class=p>;</span>       
</span></span><span class=line><span class=cl>        <span class=c1>// 符号表的数量 -&gt; 00 00 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>SizeOfOptionalHeader</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 指出IMAGE_OPTIONAL_HEADER32结构体的长度。-&gt;  00 E0 -&gt; 224字节
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// PE32+ 格式文件中使用的是IMAGE_OPTIONAL_HEADER64结构体，
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 这两个结构体尺寸是不相同的，所以需要在SizeOfOptionalHeader中指明大小。
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>Characteristics</span><span class=p>;</span>      
</span></span><span class=line><span class=cl>        <span class=c1>// 标识文件的属性，二进制中每一位代表不同属性 -&gt; 0F 01
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_FILE_HEADER</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_FILE_HEADER</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>Machine</code>字段<ul><li>指明程序能够运行的CPU型号(运行平台)：</li><li><strong>0x0000</strong> 任何处理器; <strong>0x0014C</strong> x86及后续处理器</li></ul></li><li><code>NumberOfSections</code>字段<ul><li>文件中存在的节区的总数，如果要新增节或者合并节，就要修改这个值</li></ul></li><li><strong>TimeDateStamp</strong>字段<ul><li>时间戳：文件的创建时间(和操作系统的创建时间无关)，编译器填写的</li></ul></li><li><code>SizeOfOptionalHeader</code>字段<ul><li>指出可选PE头(IMAGE_OPTIONAL_HEADER)的大小，32位PE文件默认<strong>E0h</strong>，64位PE文件默认为<strong>F0h</strong>，大小可以自定义</li></ul></li><li><code>Characteristics</code>字段<ul><li>文件属性，每个位(十六进制转化为二进制)有不同的含义，可执行文件值为10F 即0 1 2 3 8位置1</li></ul></li></ul><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020940369.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020940369.png?size=small" data-sub-html="<h2>202301121638095</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020940369.png alt="IMAGE_FILE_HEADER 结构" srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020940369.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020940369.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020940369.png?size=large 2x" data-title=202301121638095 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>IMAGE_FILE_HEADER 结构</figcaption></figure></p><h5 id=image_optional_header class=heading-element><span>IMAGE_OPTIONAL_HEADER</span>
<a href=#image_optional_header class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><strong>NT头：可选头</strong>，32位下大小为<strong>E0h</strong>个字节，64位下大小为<strong>F0h</strong>个字节</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_OPTIONAL_HEADER</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>Magic</span><span class=p>;</span>                     
</span></span><span class=line><span class=cl>        <span class=c1>// 魔数 32位为0x10B，64位为0x20B，ROM镜像为0x107&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>BYTE</span>    <span class=n>MajorLinkerVersion</span><span class=p>;</span>         
</span></span><span class=line><span class=cl>        <span class=c1>// 链接器的主版本号 -&gt; 05
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>BYTE</span>    <span class=n>MinorLinkerVersion</span><span class=p>;</span>         
</span></span><span class=line><span class=cl>        <span class=c1>// 链接器的次版本号 -&gt; 0C
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>SizeOfCode</span><span class=p>;</span>                 
</span></span><span class=line><span class=cl>        <span class=c1>// 代码节大小，一般放在“.text”节里，必须是FileAlignment的整数倍 -&gt; 40 00 04 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>SizeOfInitializedData</span><span class=p>;</span>      
</span></span><span class=line><span class=cl>        <span class=c1>// 已初始化数大小，一般放在“.data”节里，必须是FileAlignment的整数倍 -&gt; 40 00 0A 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>SizeOfUninitializedData</span><span class=p>;</span>    
</span></span><span class=line><span class=cl>        <span class=c1>// 未初始化数大小，一般放在“.bss”节里，必须是FileAlignment的整数倍 -&gt; 00 00 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>AddressOfEntryPoint</span><span class=p>;</span>       
</span></span><span class=line><span class=cl>        <span class=c1>// 指出程序最先执行的代码起始地址(RVA) -&gt; 00 00 10 00&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>BaseOfCode</span><span class=p>;</span>                 
</span></span><span class=line><span class=cl>        <span class=c1>// 代码基址，当镜像被加载进内存时代码节的开头RVA。必须是SectionAlignment的整数倍 -&gt; 40 00 10 00
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>BaseOfData</span><span class=p>;</span>                 
</span></span><span class=line><span class=cl>        <span class=c1>// 数据基址，当镜像被加载进内存时数据节的开头RVA。必须是SectionAlignment的整数倍 -&gt; 40 00 20 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 在64位文件中此处被并入紧随其后的ImageBase中。
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>ImageBase</span><span class=p>;</span>                 
</span></span><span class=line><span class=cl>        <span class=c1>// 当加载进内存时，镜像的第1个字节的首选地址。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// WindowEXE默认ImageBase值为00400000，DLL文件的ImageBase值为10000000，也可以指定其他值。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 执行PE文件时，PE装载器先创建进程，再将文件载入内存，
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 然后把EIP寄存器的值设置为ImageBase+AddressOfEntryPoint&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// PE文件的Body部分被划分成若干节段，这些节段储存着不同类别的数据。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>SectionAlignment</span><span class=p>;</span>          
</span></span><span class=line><span class=cl>        <span class=c1>// SectionAlignment指定了节段在内存中的最小单位， -&gt; 00 00 10 00&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>FileAlignment</span><span class=p>;</span>             
</span></span><span class=line><span class=cl>        <span class=c1>// FileAlignment指定了节段在磁盘文件中的最小单位，-&gt; 00 00 02 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// SectionAlignment必须大于或者等于FileAlignment&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>MajorOperatingSystemVersion</span><span class=p>;</span>	<span class=c1>// 主系统的主版本号 -&gt; 00 04
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>WORD</span>    <span class=n>MinorOperatingSystemVersion</span><span class=p>;</span>	<span class=c1>// 主系统的次版本号 -&gt; 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>WORD</span>    <span class=n>MajorImageVersion</span><span class=p>;</span>          	<span class=c1>// 镜像的主版本号 -&gt; 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>WORD</span>    <span class=n>MinorImageVersion</span><span class=p>;</span>          	<span class=c1>// 镜像的次版本号 -&gt; 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>WORD</span>    <span class=n>MajorSubsystemVersion</span><span class=p>;</span>      	<span class=c1>// 子系统的主版本号 -&gt; 00 04
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>WORD</span>    <span class=n>MinorSubsystemVersion</span><span class=p>;</span>      	<span class=c1>// 子系统的次版本号 -&gt; 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>Win32VersionValue</span><span class=p>;</span>          	<span class=c1>// 保留，必须为0 -&gt; 00 00 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>SizeOfImage</span><span class=p>;</span>               
</span></span><span class=line><span class=cl>        <span class=c1>// 当镜像被加载进内存时的大小，包括所有的文件头。向上舍入为SectionAlignment的倍数。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 一般文件大小与加载到内存中的大小是不同的。 -&gt; 00 00 50 00&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>SizeOfHeaders</span><span class=p>;</span>             
</span></span><span class=line><span class=cl>        <span class=c1>// 所有头的总大小，向上舍入为FileAlignment的倍数。                                     
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 可以以此值作为PE文件第一节的文件偏移量。-&gt; 00 00 04 00&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>CheckSum</span><span class=p>;</span>                   <span class=c1>// 镜像文件的校验和 -&gt; 00 00 B4 99
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>Subsystem</span><span class=p>;</span>                 
</span></span><span class=line><span class=cl>        <span class=c1>// 运行此镜像所需的子系统 -&gt; 00 02 -&gt; 窗口应用程序
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 用来区分系统驱动文件(*.sys)与普通可执行文件(*.exe，*.dll)，
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>DllCharacteristics</span><span class=p>;</span>         <span class=c1>// DLL标识 -&gt; 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>SizeOfStackReserve</span><span class=p>;</span>         <span class=c1>// 最大栈大小。CPU的堆栈。默认是1MB。-&gt; 00 10 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>SizeOfStackCommit</span><span class=p>;</span>          <span class=c1>// 初始提交的堆栈大小。默认是4KB -&gt; 00 00 10 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>SizeOfHeapReserve</span><span class=p>;</span>          <span class=c1>// 最大堆大小。编译器分配的。默认是1MB -&gt;00 10 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>SizeOfHeapCommit</span><span class=p>;</span>           <span class=c1>// 初始提交的局部堆空间大小。默认是4K -&gt;00 00 10 00
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>LoaderFlags</span><span class=p>;</span>                <span class=c1>// 保留，必须为0 -&gt; 00 00 00 00
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>NumberOfRvaAndSizes</span><span class=p>;</span>       
</span></span><span class=line><span class=cl>        <span class=c1>// 指定DataDirectory的数组个数，由于以前发行的Windows NT的原因，它只能为16。 -&gt; 00 00 00 10&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>IMAGE_DATA_DIRECTORY</span> <span class=n>DataDirectory</span><span class=p>[</span><span class=n>IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span><span class=p>];</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// 数据目录数组。详见下文。
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_OPTIONAL_HEADER32</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_OPTIONAL_HEADER32</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DATA_DIRECTORY</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>VirtualAddress</span><span class=p>;</span>  
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>Size</span><span class=p>;</span>  
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_DATA_DIRECTORY</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DATA_DIRECTORY</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>Magic</code>字段<ul><li>说明文件类型：</li><li>32位下的PE文件&ndash;<strong>10B</strong>， 64位下的PE文件&ndash;<strong>20B</strong></li></ul></li><li><strong>SizeOfCode</strong>字段<ul><li>所有代码节的和，必须是FileAlignment的整数倍 编译器填的</li></ul></li><li><strong>SizeOfInitializedData</strong>字段<ul><li>已初始化数据大小的和，必须是FileAlignment的整数倍 编译器填的</li></ul></li><li><strong>SizeOfUninitializedData</strong>字段<ul><li>未初始化数据大小的和，必须是FileAlignment的整数倍 编译器填的</li></ul></li><li><code>AddressOfEntryPoint</code>字段<ul><li>程序入口&mdash;AddressOfEntryPoint持有EP的RVA值。该值指出程序最先执行的代码起始地址。</li></ul></li><li><strong>BaseOfCode</strong>字段<ul><li>代码开始的基址，编译器填的</li></ul></li><li><strong>BaseOfData</strong>字段<ul><li>数据开始的基址，编译器填的</li></ul></li><li><code>ImageBase</code>字段<ul><li>内存镜像基址。进程虚拟内存的范围是0000 0000 ~ FFFF FFFF(32位系统)。PE文件被加载到内存中时，ImageBase 指出文件的优先装入地址。</li><li>EXE、DLL文件被装载到用户内存的0000 0000 ~ 7FFF FFFF中，SYS文件被载入内核内存的8000 0000 ~ FFFF FFFF中。一般而言，使用开发攻击(VB/VC++/Dephi)创建好EXE文件后，其执行PR文件时，PE装载器先创建进程，再将文件载入内存，然后把EIP寄存器的值设置为 <strong>ImageBase + AddressOfEntryPoint</strong></li></ul></li><li><code>SectionAlignment</code>字段<ul><li>内存对齐&mdash;节区在内存中的最小单位</li></ul></li><li><code>FileAlignment</code>字段<ul><li>文件对齐&mdash;节区再磁盘文件中的最小单位</li></ul></li><li><code>SizeOfImage</code>字段<ul><li>内存中整个PE文件的映射的尺寸，可以比实际的值大，但必须是SectionAlignment的整数倍</li></ul></li><li><code>SizeOfHeaders</code>字段<ul><li>所有头与节表按照 <strong>文件对齐</strong> 后的大小，否则加载会出错</li><li>指出整个PE头的大小[ DOS + NT( NT + File + Optional ) ]。该值也是FileAlignment的整数倍。第一节区所在位置与SizeOfHeader距文件开始偏移的量相同</li></ul></li><li><strong>CheckSum</strong> 字段<ul><li>校验和，一些系统文件有要求.用来判断文件是否被修改</li></ul></li><li><strong>SizeOfStackReserve</strong> 字段<ul><li>初始化时保留的堆栈大小</li></ul></li><li><strong>SizeOfStackCommit</strong> 字段<ul><li>初始化时实际提交的大小</li></ul></li><li><strong>SizeOfHeapReserve</strong> 字段<ul><li>初始化时保留的堆大小</li></ul></li><li><strong>SizeOfHeapCommit</strong> 字段<ul><li>初始化时实践提交的大小</li></ul></li><li><code>NumberOfRvaAndSizes</code> 字段<ul><li>目录项数目</li><li>指出 Data_Directory（IMAGE_OPTIONAL_HEADER32结构体的最后一个成员）数组的个数。</li></ul></li><li><code>Data_Directory</code> 字段<ul><li>数据目录表，由NumberOfRvaAndSize个IMAGE_DATA_DIRECTORY结构体组成的数组。该数组包含输入表，输出表，资源，重定位等数据目录项的RVA和大小。</li></ul></li></ul><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020950878.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020950878.png?size=small" data-sub-html="<h2>202302242139607</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020950878.png alt=结构体数组 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020950878.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020950878.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202304020950878.png?size=large 2x" data-title=202302242139607 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>结构体数组</figcaption></figure></p><h4 id=节区头节表 class=heading-element><span>节区头(节表)</span>
<a href=#%e8%8a%82%e5%8c%ba%e5%a4%b4%e8%8a%82%e8%a1%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><strong>IMAGE_SECTION_HEADER</strong>
在PE文件头与原始数据之间存在一个区块表(Section Table)，它是一个IMAGE_SECTION_HEADER结构数组，<code>区块表包含每个块在映像中的信息</code>(如位置、长度、属性)，分别指向不同的区块实体</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_SECTION_HEADER</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Name</span>						<span class=c1>//8个字节的块名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>union</span>						
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span> <span class=n>PhysicalAddress</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span> <span class=n>VirtualSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>Misc</span><span class=p>;</span>                     <span class=c1>//区块尺寸(真实)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>VirtualAddress</span><span class=p>;</span>		<span class=c1>//区块的RVA地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>SizeOfRawData</span><span class=p>;</span>		<span class=c1>//在文件中对齐后的尺寸
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>PointerToRawData</span><span class=p>;</span>		<span class=c1>//在文件中偏移
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>PointerToRelocations</span><span class=p>;</span>	<span class=c1>//在OBJ文件中使用，重定位的偏移
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>PointerToLinenumbers</span><span class=p>;</span>	<span class=c1>//行号表的偏移(供调试使用地)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span> <span class=n>NumberOfRelocations</span><span class=p>;</span>	<span class=c1>//在OBJ文件中使用，重定位项数目
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span> <span class=n>NumberOfLinenumbers</span><span class=p>;</span>	<span class=c1>//行号表中行号的数目
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>Characteristics</span><span class=p>;</span>		<span class=c1>//区块属性如可读，可写，可执行等
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_SECTION_HEADER</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_SECTION_HEADER</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>Name</code><ul><li><strong>8个字节</strong> 一般情况下是以 &ldquo;\0&rdquo; 结尾的 ASCII 码字符串来标识的名称，内容可以自定义</li></ul></li><li><code>Misc</code><ul><li><strong>双字</strong> 是该节在没有对齐前的真实尺寸,该值可以不准确</li></ul></li><li><code>VirtualSize</code><ul><li>内存中节区所占大小</li></ul></li><li><code>VirtualAddress</code><ul><li>节区在 <strong>内存中</strong> 的偏移地址(RVA)。加上ImageBase才是在内存中的真正地址。由 SectionAlignment 确定</li></ul></li><li><code>SizeOfRawData</code><ul><li>节区在 <strong>文件中</strong> 对齐后的尺寸&mdash;磁盘文件中节区所占大小</li></ul></li><li><code>PointerToRawData</code><ul><li>节区在 <strong>文件中</strong> 的偏移&mdash;磁盘文件中节区的起始位置。由 FileAlignment 确定</li></ul></li><li><code>Characteristics</code><ul><li><p>节区属性（bit OR）</p><p><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128040.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128040.png?size=small" data-sub-html><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128040.png alt=202302242144521 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128040.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128040.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128040.png?size=large 2x" data-title=202302242144521 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p></li></ul></li></ul><h3 id=rva-to-raw class=heading-element><span>RVA to RAW</span>
<a href=#rva-to-raw class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>PE文件从磁盘到内存映射&mdash;PE文件加载到内存时，每个节区都要能准确完成内存地址与文件偏移间的映射（RVA to RAW）.方法如下：</p><ol><li>查早RVA所在节区</li><li>使用简单的公式计算文件偏移（RAW/FOA）
$$
RAW(FOA) - PointerToRawData = RVA - VirtualAddress
$$</li></ol><p>PointerToRawData：<strong>磁盘文件中</strong>节区的起始位置。由 FileAlignment 确定</p><p>virtualAddress：<strong>内存中</strong>节区起始地址（RVA）</p><h3 id=数据目录 class=heading-element><span>数据目录</span>
<a href=#%e6%95%b0%e6%8d%ae%e7%9b%ae%e5%bd%95 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li><a href=https://blog.csdn.net/qq_35289660/category_9995600.html target=_blank rel="external nofollow noopener noreferrer">PE文件结构_C4cke的博客-CSDN博客</a></li><li><a href="https://www.anquanke.com/member.html?memberId=156165" target=_blank rel="external nofollow noopener noreferrer">深度理解win32</a></li></ul><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128802.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128802.png?size=small" data-sub-html="<h2>202302261105566</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128802.png alt=结构体数组 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128802.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128802.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128802.png?size=large 2x" data-title=202302261105566 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>结构体数组</figcaption></figure></p><h4 id=导出表 class=heading-element><span>导出表</span>
<a href=#%e5%af%bc%e5%87%ba%e8%a1%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>**基本概念：**导出表是PE文件为其他应用程序提供自身的一些变量、函数以及类，将其导出给第三方程序使用的一张清单，里面包含了可以导出的元素。位于数据目录项的第一个结构</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DATA_DIRECTORY</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>DWORD</span> <span class=n>VirtualAddress</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>DWORD</span> <span class=n>Size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_DATA_DIRECTORY</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DATA_DIRECTORY</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>VirtualAddress</code>：真正导出表的RVA</li><li><code>Size</code>：导出表的大小，在这个地方的结构只是说明了导出表在<strong>内存中</strong>所存在的地址以及导出表的大小，并不是真正的导出表，需要通过RVA去找到导出表真正存在的地址</li></ul><h5 id=image_export_directory class=heading-element><span>IMAGE_EXPORT_DIRECTORY</span>
<a href=#image_export_directory class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>真正的导出表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_EXPORT_DIRECTORY</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span> <span class=n>Characteristics</span><span class=p>;</span> 				<span class=c1>// 未使用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>TimeDateStamp</span><span class=p>;</span> 				<span class=c1>// 时间戳
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span> <span class=n>MajorVersion</span><span class=p>;</span> 					<span class=c1>// 未使用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span> <span class=n>MinorVersion</span><span class=p>;</span> 					<span class=c1>// 未使用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>Name</span><span class=p>;</span> 					    <span class=c1>// 指向该导出表文件名字符串
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>Base</span><span class=p>;</span> 					    <span class=c1>// 导出函数起始序号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>NumberOfFunctions</span><span class=p>;</span> 			 <span class=c1>// 所有导出函数的个数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>NumberOfNames</span><span class=p>;</span> 				 <span class=c1>// 以函数名字导出的函数个数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>AddressOfFunctions</span><span class=p>;</span> 			 <span class=c1>// 导出函数地址表RVA
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>AddressOfNames</span><span class=p>;</span> 				 <span class=c1>// 导出函数名称表RVA
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span> <span class=n>AddressOfNameOrdinals</span><span class=p>;</span> 		 <span class=c1>// 导出函数序号表RVA
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_EXPORT_DIRECTORY</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_EXPORT_DIRECTORY</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li>导出表导出方式为两种，分别是以 <strong>名字导出</strong>、以 <strong>序号导出</strong>：</li><li><strong>AddressOfFunctions、AddressOfNames、AddressOfNameOrdinal</strong> 这三个RVA指向的是三个存放了函数具体地址的表，如下图所示<ul><li><strong>AddressOfFunctions</strong> 存放的地址数量由NumberOfFuntions决定，</li><li><strong>AddressOfNameOrdinals</strong> 和 <strong>AddressOfNames</strong> 存放的地址数量由NumberOfNames来决定</li></ul></li></ul><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128759.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128759.png?size=small" data-sub-html="<h2>202302261031945</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128759.png alt=导出表 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128759.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128759.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128759.png?size=large 2x" data-title=202302261031945 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>导出表</figcaption></figure></p><h6 id=addressofnames class=heading-element><span>AddressOfNames</span>
<a href=#addressofnames class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>这个表里面的宽度为4字节，即0x12345678，存放的地址也为RVA，在这个表里面，名称是按字符顺序排序的。例如有一个函数名称为apple，另外一个函数名称为bee，那么apple的RVA就在这个表里面的第一项，bee的RVA就在这个表里面的第二项，但是这个可能并不是函数真正的名字，如下图所示</p><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128671.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128671.png?size=small" data-sub-html="<h2>202302261034484</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128671.png alt=AddressOfNames srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128671.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128671.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291128671.png?size=large 2x" data-title=202302261034484 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>AddressOfNames</figcaption></figure></p><h6 id=addressofnameordinals class=heading-element><span>AddressOfNameOrdinals</span>
<a href=#addressofnameordinals class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>这个表里面的宽度为2字节，存放的地址也为RVA，通过这个表里面的内容加上Base就可以得到函数的导出序号</p><h6 id=addressoffunctions class=heading-element><span>AddressOfFunctions</span>
<a href=#addressoffunctions class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>这个表里面的宽度也是4字节，存放的是所有导出函数的地址，这个地址也是RVA，所以要想得到真正的地址需要加上ImageBase</p><h5 id=导出方式 class=heading-element><span>导出方式</span>
<a href=#%e5%af%bc%e5%87%ba%e6%96%b9%e5%bc%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><ul><li>以名字导出<ul><li>首先遍历名字表(AddressOfNames)，用名字表中的地址找字符串，与目标字符串比对。如果找到字符串一样的，得到该处的索引。按照相同的索引号从序号表中找到序号值(即<strong>名字表与序号表的下标相同</strong>)，再通过序号值(序号表中的value)为索引，从地址表中找到目标函数的地址(RVA)，之后这个地址需要加上ImagBase，即可得到真正导出函数的地址</li></ul></li><li>以序号导出<ul><li>用目标序号-BASE，得到一个值，直接用这个值为索引，从地址表中找函数的地址(RVA)，之后这个地址需要加上ImagBase，即可得到真正导出函数的地址</li></ul></li></ul><h4 id=导入表 class=heading-element><span>导入表</span>
<a href=#%e5%af%bc%e5%85%a5%e8%a1%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><strong>基本概念</strong>：导入表是记录 PE 文件中用到的动态连接库的集合，一个 dll 库在导入表中占用一个元素信息的位置，这个元素描述了该导入 dll 的具体信息。如 dll 的最新修改时间、dll 中函数的名字/序号、dll 加载后的函数地址等。</p><div class="details admonition info"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-circle-info" aria-hidden=true></i>DLL补充<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>DLL（Dynamic Linked Library）是动态链接库：</p><ul><li>不把库包含到程序中，单独组成DLL文件，需要时调用即可</li><li>内存映射技术使加载后的DLL代码、资源在多个进程中实现共享</li><li>更新库时只要替换相关文件即可，简便易行</li></ul><p>DLL加载：</p><ol><li>显示链接：程序使用DLL时加载，使用完毕后释放内存；</li><li>隐式链接：程序开始时即一同加载DLL，程序终止时再释放占用的内存</li></ol><p>这里 IAT提供的机制即与隐式链接有关</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DATA_DIRECTORY</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>VirtualAddress</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>Size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_DATA_DIRECTORY</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DATA_DIRECTORY</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>VirtualAddress</code>：指向真正导入表结构的RVA</li><li><code>Size</code>：导入表的大小</li></ul></div></div></div><h5 id=image_import_descriptor class=heading-element><span>IMAGE_IMPORT_DESCRIPTOR</span>
<a href=#image_import_descriptor class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>​IMAGE_IMPORT_DESCRIPTOR 结构体中记录着 PE 文件要导入哪些库文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_IMPORT_DESCRIPTOR</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>Characteristics</span><span class=p>;</span>            <span class=c1>//导入表结束标志
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span>   <span class=n>OriginalFirstThunk</span><span class=p>;</span>         <span class=c1>//RVA 指向IMAGE_THUNK_DATA结构体数组(INT表)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>TimeDateStamp</span><span class=p>;</span>                  <span class=c1>//时间戳
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span>   <span class=n>ForwarderChain</span><span class=p>;</span>                 <span class=c1>// -1 if no forwarders
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span>   <span class=n>Name</span><span class=p>;</span>                           <span class=c1>//RVA指向dll名字，以0结尾
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span>   <span class=n>FirstThunk</span><span class=p>;</span>                     <span class=c1>//RVA 指向IMAGE_THUNK_DATA结构体数组(IAT表)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_IMPORT_DESCRIPTOR</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=n>IMAGE_IMPORT_DESCRIPTOR</span> <span class=n>UNALIGNED</span> <span class=o>*</span><span class=n>PIMAGE_IMPORT_DESCRIPTOR</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>执行一个普通程序往往需要导入多个库，导入多少库就存在多少个 <strong>IMAGE_IMPORT_DESCRIPTOR 结构体</strong>，这些结构体组成了数组，且结构体数组最后以NULL结束。</p><ul><li><code>OriginalFirstThunk</code><ul><li>该字段保存了指向 <strong>导入函数名称（序号）</strong> 的 RVA 表（<strong>INT表</strong>），这个表其实是一个 IMAGE_THUNK_DATA结构体</li></ul></li><li><code>Name</code><ul><li>RVA，指向dll名字（库名称字符串的地址），该名字以 0 结尾</li></ul></li><li><code>FirstThunk</code><ul><li>RVA，指向IMAGE_THUNK_DATA结构数组，即 <strong>指向IAT表</strong></li><li>该字段保存了指向导入地址表的 RVA，在 <strong>PE 文件没有被装载前</strong> 它的内容与 OriginalFirstThunk 指向相同的内容，也就是在 PE 文件没有被装载前它也指向 IMAGE_THUNK_ DATA 结构体。</li><li>当<strong>被 Windows 操作系统装入内存后</strong>，它的值则发生了变化，被装载入内存后，这里保存了导入函数实际地址</li></ul></li></ul><h6 id=originalfirstthunk class=heading-element><span>OriginalFirstThunk</span>
<a href=#originalfirstthunk class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><ul><li><strong>OriginalFirstThunk</strong> 这个RVA所指向的是INT表（Import Name Table），这个表每个数据占4个字节。顾名思义就是表示要导入的函数的名字表</li><li><code>INT</code>：<ul><li>如果这个4字节数的最高位（二进制）为1，那么抹去这个最高位之后，所表示的数就是要导入的函数的序号；</li><li>如果最高位是0，那这个数就也是一个RVA，指向IMAGE_IMPORT_BY_NAME结构体（包含真正的导入函数的名字字符串，以0结尾）。INT表以4字节0结尾。</li></ul></li><li><code>IMAGE_IMPORT_BY_NAME</code>：前两个字节是一个序号，不是导入序号，一般无用，后面接着就是导入函数名字的字符串，以0结尾。</li></ul><h6 id=name class=heading-element><span>Name</span>
<a href=#name class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>这个结构体变量也是一个RVA，直接指向一个字符串，这个字符串就是这个导入表对应的DLL的名字。一个导入表只对应一个DLL。存在多个导入表，则对应目录项里的VirtualAddress（RVA）指向的是所有导入表的首地址，每个导入表占20字节，挨着。最后以一个空结构体作为结尾（20字节全0结构体）。</p><h6 id=firstaddress class=heading-element><span>FirstAddress</span>
<a href=#firstaddress class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><ul><li><p>FirstAddress（RVA）指向的就是<strong>IAT表</strong>。IAT 表也是每个数据占4个字节。最后以4字节0结尾。</p></li><li><p><code>PE加载：</code></p><ul><li><p>PE加载前，IAT 表和 INT 表完全相同，此时 IAT 表可以判断函数导出序号，或指向函数名字结构体
<a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129288.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129288.png?size=small" data-sub-html><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129288.png alt=202302261010635 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129288.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129288.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129288.png?size=large 2x" data-title=202302261010635 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p></li><li><p>PE加载后：IAT 表发生变化，系统会现根据结构体变量 Name 加载对应的 dll（拉伸），读取dll的导出表，对应原程序的 INT 表，匹配 dll 导出函数的地址，返回其地址，贴在对应的 IAT 表上，挨个修正地址（即GetPeocAddress）
<a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129939.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129939.png?size=small" data-sub-html><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129939.png alt=202302261010941 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129939.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129939.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129939.png?size=large 2x" data-title=202302261010941 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p></li></ul></li></ul><h5 id=image_thunk_data class=heading-element><span><strong>IMAGE_THUNK_DATA</strong></span>
<a href=#image_thunk_data class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_THUNK_DATA32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span> <span class=n>ForwarderString</span><span class=p>;</span>      <span class=c1>// PBYTE 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span> <span class=n>Function</span><span class=p>;</span>             <span class=c1>// PDWORD，被输入的函数的内存地址
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span> <span class=n>Ordinal</span><span class=p>;</span>			   <span class=c1>// 被输入的API的序数值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>DWORD</span> <span class=n>AddressOfData</span><span class=p>;</span>        <span class=c1>// RVA 指向_IMAGE_IMPORT_BY_NAME 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=n>u1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_THUNK_DATA32</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=n>IMAGE_THUNK_DATA32</span> <span class=o>*</span> <span class=n>PIMAGE_THUNK_DATA32</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li>首先要判断最高位是否为1，如果最高位的值为1，那么去除最高位的值之后，即为函数的导出序号</li><li>如果最高位的值不为1，那么这个值就是一个RVA，在转成FOA之后指向<code>IMAGE_IMPORT_BY_NAME</code>这个结构</li></ul><h5 id=image_import_by_name class=heading-element><span>IMAGE_IMPORT_BY_NAME</span>
<a href=#image_import_by_name class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_IMPORT_BY_NAME</span> <span class=p>{</span>                
</span></span><span class=line><span class=cl>    <span class=n>WORD</span>    <span class=n>Hint</span><span class=p>;</span>                
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span>    <span class=n>Name</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>                
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_IMPORT_BY_NAME</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_IMPORT_BY_NAME</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li>Hint为 2 字节，为当前函数在导出表中的索引，但是这个值一般起不到什么作用。我们思考一下，如果我们最高位值为 1 是以序号导出，最高位值不为 1 则以名字导出，而以名字导出的时候我们才会用到 <code>IMAGE_IMPORT_BY_NAME</code> 结构，但是我们按名字导出也就不需要管函数的索引了，所以 Hint 这个值可以忽略，在一些编译器里面会直接将Hint的值置为 0。</li><li>我们主要是看一下 <code>Name[1]</code> 这个结构，可以看到它是 BYTE，大小为 1 字节。因为考虑到了函数名字长度的不确定性，设计者只将函数开头的1字节存到 <code>Name[1]</code> 这个结构中，函数名是以 <code>\0</code> 结尾的，也就是说在找到 <code>Name[1]</code> 里面所存的首字节后，一直往后遍历，直到找到 0 即为函数名的结束。</li></ul><h5 id=绑定导入表 class=heading-element><span>绑定导入表</span>
<a href=#%e7%bb%91%e5%ae%9a%e5%af%bc%e5%85%a5%e8%a1%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>PE在加载前INT、IAT表都指向一个名称表，但是有的exe程序，在打印IAT表的时候，会发现里面是地址。这是因为我们的PE程序在加载的时候，IAT表会填写函数地址。但是这就造成了一个问题，PE程序启动慢，每次启动都要给IAT表填写函数地址。那么这里我们就可以使用到绑定导入表来使PE程序的启动变快。</p><ul><li>注意：<code>TimeDataStamp</code>（时间戳）。PE加载EXE相关的DLL时，首先会根据<code>IMAGE_IMPORT_DESCRIPTOR</code>结构中的<code>TimeDateStamp</code>来判断是否要重新计算IAT表中的地址。若<code>TimeDataStamp == 0</code> 则未绑定，<code>TimeDataStamp == -1</code> 则已绑定<ul><li>一般的PE文件在加载前INT和IAT表中都是指向<code>IMAGE_IMPORT_BY_NAME</code>这张表的，也就是说INT表和IAT表在PE加载前表中所存的内容都是一样的。</li><li>PE在加载后，IAT表里存的才是函数的地址，这种情况就属于没有绑定导入表的情况，即<code>TimeDataStamp</code>为0的情况。</li></ul></li></ul><p>​真正的绑定导入表位于目录的第12项，其中<code>TimeDataStamp</code>为真正的时间戳，<code>OffsetModuleName</code>为剩余dll的名字，<code>NumberOfModuleForwarderRefs</code>为依赖dll的数量</p><p><strong>IMAGE_BOUND_IMPORT_DESCRIPTOR</strong> 结构</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_BOUND_IMPORT_DESCRIPTOR</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>TimeDateStamp</span><span class=p>;</span>　　　　　　　　　　　　　　　　<span class=c1>//真正的时间戳
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>    <span class=n>OffsetModuleName</span><span class=p>;</span>　　　　　　　　　　　　　　<span class=c1>//DLL的名字,PE的文件名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>    <span class=n>NumberOfModuleForwarderRefs</span><span class=p>;</span>　　　　　　　　<span class=c1>//依赖的另外的DLL有几个
</span></span></span><span class=line><span class=cl><span class=c1>// Array of zero or more IMAGE_BOUND_FORWARDER_REF follows
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_BOUND_IMPORT_DESCRIPTOR</span><span class=p>,</span>  <span class=o>*</span><span class=n>PIMAGE_BOUND_IMPORT_DESCRIPTOR</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li>其中要注意的是<code>OffsetModuleName</code>这个值有点特殊，它既不是foa，也不是rva，它的计算公式为第一个<code>DESCRIPTOR</code>的值加上所在结构体的<code>OffsetMoudeleName</code>得到。如果<code>NumberOfModuleForwarderRefs</code>的值为2，则绑定导入表一共就有3个dll。</li><li>如果<code>NumberOfModuleForwarderRefs</code>的值不为0，绑定导入表下面还会跟一张依赖dll的绑定导入表结构，含义的话跟绑定导入表相同，<code>Reserved</code>值可以不用管。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_BOUND_FORWARDER_REF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>TimeDateStamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>WORD</span>    <span class=n>OffsetModuleName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>WORD</span>    <span class=n>Reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_BOUND_FORWARDER_REF</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_BOUND_FORWARDER_REF</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><h4 id=重定位表 class=heading-element><span>重定位表</span>
<a href=#%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><strong>基本概念</strong>：基址重定位表（Base Relocation Table）用于在程序加载到内存中时，进行内存地址的修正。由于一个dll中的需要修正的地址不止一两个，可能有很多，所以用一张表记录那些 “写死” 的地址，将来加载进内存时，可能需要一一修正，这张表称作为重定位表，一般每一个PE文件都有一个重定位表。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DATA_DIRECTORY</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>VirtualAddress</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>Size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_DATA_DIRECTORY</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DATA_DIRECTORY</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>VirtualAddress</code>：存放真正重定位表地址的RVA</li><li><code>Size</code>：重定位表的大小</li></ul><h5 id=image_base_relocation class=heading-element><span>IMAGE_BASE_RELOCATION</span>
<a href=#image_base_relocation class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_BASE_RELOCATION</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>VirtualAddress</span><span class=p>;</span>  <span class=c1>//RVA
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span>   <span class=n>SizeOfBlock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_BASE_RELOCATION</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=n>IMAGE_BASE_RELOCATION</span> <span class=err>，</span><span class=o>*</span> <span class=n>PIMAGE_BASE_RELOCATION</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><h6 id=sizeofblock class=heading-element><span>SizeOfBlock</span>
<a href=#sizeofblock class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>重定位表的核心结构，存储的值以字节为单位，表示的是重定位表的大小</p><h6 id=判断重定位表的数量 class=heading-element><span>判断重定位表的数量</span>
<a href=#%e5%88%a4%e6%96%ad%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a8%e7%9a%84%e6%95%b0%e9%87%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>规定在最后一个结构的VirtualAddress和SizeOfBlock的值都为0，这里就可以进行判断来获取重定位表有多少个结构。例如：假设重定位结构的数量为3，那么在最后8字节即VirtualAddress和SizeOfBlock的值都为0，可以说重定位表就是很多个块结构所构成的。<figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129308.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129308.png?size=small" data-sub-html="<h2>202302261049857</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129308.png alt=重定位表 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129308.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129308.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129308.png?size=large 2x" data-title=202302261049857 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>重定位表</figcaption></figure></p><h6 id=具体项 class=heading-element><span>具体项</span>
<a href=#%e5%85%b7%e4%bd%93%e9%a1%b9 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><ul><li>在每一块结构的VirtualAddress和SizeOfBlock里面，都有很多宽度为2字节的十六进制数据，这里我们称他们为具体项。</li><li>在内存中页大小的值为1000H，即2的12次方，也就是通过这个1000H就能够表示出一个页里面所有的偏移地址。而具体项的宽度为16位，页大小的值为低12位。</li><li>高四位为0011或0000，对应的十进制就是3或0.<ul><li><strong>当高4位的值为0011</strong>，我们需要修复的数据地址就是VirtualAddress + 低12位的值。<ul><li>例如VirtualAddress是0x12345678，具体项的数值为001100000001，那么这个值就是有意义的，需要修改的RVA = 0x12345678+0x00000001 = 0x12345679。</li></ul></li><li><strong>当高4位的值为0000</strong>，这里就不需要进行重定位的修改，这里的具体项只是用于数据对齐的数据。</li></ul></li></ul><h4 id=资源表 class=heading-element><span>资源表</span>
<a href=#%e8%b5%84%e6%ba%90%e8%a1%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>**背景：**资源表是PE所有表里边最复杂的表，造成资源表复杂是有历史原因的，简单说就是微软设计PE的时候错误的以为只要定义16位中的资源类型就够了，后来发现远远不够，但是PE结构已经定下来了，只能在原有基础上修改，因此就造成了资源表这块比较不好理解。</p><ul><li>所谓的不好理解，就是它里边用到的结构，其中的属性会出现<strong>位段/位域</strong>的用法<ul><li>同一个4字节，要根据高位判断它到底是一个整数还是一个偏移；</li><li>偏移并不是RVA，而是相对于资源表的偏移</li></ul></li></ul><h5 id=image_resource_directory class=heading-element><span>IMAGE_RESOURCE_DIRECTORY</span>
<a href=#image_resource_directory class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>资源目录的结构</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_RESOURCE_DIRECTORY</span> <span class=p>{</span>                                
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span>   <span class=n>Characteristics</span><span class=p>;</span>                        	<span class=c1>//资源属性  保留 0        
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DWORD</span>   <span class=n>TimeDateStamp</span><span class=p>;</span>                        		<span class=c1>//资源创建的时间        
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>    <span class=n>MajorVersion</span><span class=p>;</span>                        		<span class=c1>//资源版本号 未使用 0        
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>    <span class=n>MinorVersion</span><span class=p>;</span>                        		<span class=c1>//资源版本号 未使用 0        
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>    <span class=n>NumberOfNamedEntries</span><span class=p>;</span>                        <span class=c1>//以名称命名的资源数量        
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WORD</span>    <span class=n>NumberOfIdEntries</span><span class=p>;</span>                           <span class=c1>//以ID命名的资源数量        
</span></span></span><span class=line><span class=cl><span class=c1>//  IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[];                                
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_RESOURCE_DIRECTORY</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_RESOURCE_DIRECTORY</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><h5 id=资源表的真正结构 class=heading-element><span>资源表的真正结构</span>
<a href=#%e8%b5%84%e6%ba%90%e8%a1%a8%e7%9a%84%e7%9c%9f%e6%ad%a3%e7%bb%93%e6%9e%84 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><figure><a class=lightgallery href="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129287.png?size=large" data-thumbnail="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129287.png?size=small" data-sub-html="<h2>202302261111997</h2>"><img loading=lazy src=https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129287.png alt=资源表真正结构 srcset="https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129287.png?size=small, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129287.png?size=medium 1.5x, https://nuthecz.oss-cn-hangzhou.aliyuncs.com/file/202303291129287.png?size=large 2x" data-title=202302261111997 style="background:url(/blog/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a><figcaption class=image-caption>资源表真正结构</figcaption></figure></p><p>其中每一层都有一个资源目录这个结构，这个结构的意义就是用来统计有多少个 <code>IMAGE_RESOURCE_DIRECTORY_ENTRY</code> 结构</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_RESOURCE_DIRECTORY_ENTRY</span> <span class=p>{</span>                                
</span></span><span class=line><span class=cl>    <span class=k>union</span> <span class=p>{</span>                        				    <span class=c1>//目录项的名称、或者ID        
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>struct</span> <span class=p>{</span>                                
</span></span><span class=line><span class=cl>            <span class=n>DWORD</span> <span class=nl>NameOffset</span><span class=p>:</span><span class=mi>31</span><span class=p>;</span>                                
</span></span><span class=line><span class=cl>            <span class=n>DWORD</span> <span class=nl>NameIsString</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>                                
</span></span><span class=line><span class=cl>        <span class=p>};</span>                                
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>Name</span><span class=p>;</span>                                
</span></span><span class=line><span class=cl>        <span class=n>WORD</span>    <span class=n>Id</span><span class=p>;</span>                                
</span></span><span class=line><span class=cl>    <span class=p>};</span>                                
</span></span><span class=line><span class=cl>    <span class=k>union</span> <span class=p>{</span>                                
</span></span><span class=line><span class=cl>        <span class=n>DWORD</span>   <span class=n>OffsetToData</span><span class=p>;</span>                        <span class=c1>//目录项指针        
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>struct</span> <span class=p>{</span>                                
</span></span><span class=line><span class=cl>            <span class=n>DWORD</span>   <span class=nl>OffsetToDirectory</span><span class=p>:</span><span class=mi>31</span><span class=p>;</span>                                
</span></span><span class=line><span class=cl>            <span class=n>DWORD</span>   <span class=nl>DataIsDirectory</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>                                
</span></span><span class=line><span class=cl>        <span class=p>};</span>                                
</span></span><span class=line><span class=cl>    <span class=p>};</span>                                
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_RESOURCE_DIRECTORY_ENTRY</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_RESOURCE_DIRECTORY_ENTRY</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p><code>IMAGE_RESOURCE_DIRECTORY_ENTRY</code>这个结构在每一层里面的含义都不相同，在第一层用来判断资源的类型，第二层用来判断资源的编号，第三层表示的是代码页</p><h6 id=第一层 class=heading-element><span>第一层</span>
<a href=#%e7%ac%ac%e4%b8%80%e5%b1%82 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p><strong>第一个联合体</strong></p><p><code>资源类型</code>：每种资源有类型及名字，它们是数值标识符或字符串。windows定义了十六种预定义类型，如光标对应1，位图对应2，图标对应3等等。而资源类型既可以用序号表示，也可以用字符串表示。第一层里Name表示的就是资源类型，使用NameIsString判断资源类型用什么表示</p><ul><li><code>DWORD NameOffset:31;</code> 和 <code>DWORD NameIsString:1;</code> 这两个值，<ul><li><code>NameOffset:31</code> 就是表示占低31位，而 <code>NameIsString</code> 则占剩下的1位</li></ul></li><li>当最高位为1时，即 <code>NameIsString = 1</code> 时，低31位为一个UNICODE指针，指向 <code>_IMAGE_RESOURCE_DIR_STRING_U</code> 结构，在这个结构里面 <code>Length</code> 表示长度，<code>NameString[1]</code> 表示的是真正UNICODE起始的地址（字符串表示）</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>ypedef</span> <span class=k>struct</span> <span class=n>_IMAGE_RESOURCE_DIR_STRING_U</span> <span class=p>{</span>                        
</span></span><span class=line><span class=cl>    <span class=n>WORD</span>    <span class=n>Length</span><span class=p>;</span>                        
</span></span><span class=line><span class=cl>    <span class=n>WCHAR</span>   <span class=n>NameString</span><span class=p>[</span> <span class=mi>1</span> <span class=p>];</span>                        
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>IMAGE_RESOURCE_DIR_STRING_U</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_RESOURCE_DIR_STRING_U</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li>当最高位为0时，表示字段的值作为 ID 使用</li></ul><p><strong>第二个资源体</strong></p><p><code>OffsetToData</code>：这个并不是一个RVA，</p><ul><li>当<code>OffsetToData</code>的最高位为1时，这里需要用资源表的起始地址加上<code>OffsetToData</code>的低31位得到的内存地址，就是第二层结构所在的起始地址</li><li>若最高位为0，则指向<code>IMAGE_RESOURCE_DATA_ENTRY</code>结构</li></ul><h6 id=第二层 class=heading-element><span>第二层</span>
<a href=#%e7%ac%ac%e4%ba%8c%e5%b1%82 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><ul><li><code>IMAGE_RESOURCE_DIRECTORY</code> 跟 <code>IMAGE_RESOURCE_DIRECTORY_ENTRY</code> 结构与第一层的相同</li><li><code>Name</code> 字段表示的就是资源的编号了，可以理解为有几个资源的意思</li></ul><h6 id=第三层 class=heading-element><span>第三层</span>
<a href=#%e7%ac%ac%e4%b8%89%e5%b1%82 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><ul><li><code>IMAGE_RESOURCE_DIRECTORY</code> 跟 <code>IMAGE_RESOURCE_DIRECTORY_ENTRY</code> 结构与第一层的相同</li><li><code>Name</code> 字段表示的就是代码页&mdash;-代码页是字符集编码的别名，也有人称”内码表”。这里通俗点来说的话，就是每个国家自己的语言都有一个代码页，简体中文的代码页编号就是2052</li><li>通过第一个联合体判断是以字符串还是以数值表示，然后第二个联合体也跟之前的方法相同，这里通过计算得到的地址就是指向数据项即<code>_IMAGE_DATA_DIRECTORY</code>结构</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_DATA_DIRECTORY</span> <span class=p>{</span>                    
</span></span><span class=line><span class=cl>      <span class=n>DWORD</span>   <span class=n>VirtualAddress</span><span class=p>;</span>                    
</span></span><span class=line><span class=cl>      <span class=n>DWORD</span>   <span class=n>Size</span><span class=p>;</span>                    
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=n>IMAGE_DATA_DIRECTORY</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_DATA_DIRECTORY</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>VirtualAddress</code>是RVA，表示资源真正存储的位置，</li><li><code>Size</code>表示资源的大小</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2025-02-22 08:27:45">更新于 2025.2.22&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href="https://github.com/czTangt/blog.git/blob/main/content/posts%5creverse%5cwindows.md?plain=1" title=查看源码 target=_blank rel="external nofollow noopener noreferrer" class=link-to-source>查看源码</a></span><span><a href=https://github.com/czTangt/blog.git/edit/main/content/posts%5creverse%5cwindows.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span><span><a href="https://github.com/czTangt/blog.git/issues/new?title=[BUG]%20Windows&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cWindows%7c%0A%7cURL%7chttps://czTangt.github.io/blog/posts/reverse/windows/%7c%0A%7cFilename%7chttps://github.com/czTangt/blog.git/blob/main/content/posts%5creverse%5cwindows.md?plain=1%7c" title=报告问题 target=_blank rel="external nofollow noopener noreferrer" class=link-to-report>报告问题</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://czTangt.github.io/blog/posts/reverse/windows/ data-title=Windows data-hashtags=reverse><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://czTangt.github.io/blog/posts/reverse/windows/ data-hashtag=reverse><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://czTangt.github.io/blog/posts/reverse/windows/ data-title=Windows><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/blog/tags/reverse/ class=post-tag title="标签 - Reverse">Reverse</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/blog/>主页</a></span></section></div><div class=post-nav><a href=/blog/posts/android/android-reverse/ class=post-nav-item rel=prev title="Android Reverse"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Android Reverse</a></div></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.136.5"><img class=hugo-icon src=/blog/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.17-30a67c4b"><img class=fixit-icon src=/blog/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2024 - 2025</span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><a href=https://github.com/czTangt/blog title="View source on GitHub" target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/blog/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=preload href=/blog/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/blog/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/blog/lib/cookieconsent/cookieconsent.min.css><script src=/blog/lib/autocomplete/autocomplete.min.js defer></script><script src=/blog/lib/fuse/fuse.min.js defer></script><script src=/blog/lib/lightgallery/lightgallery.min.js defer></script><script src=/blog/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/blog/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/blog/lib/sharer/sharer.min.js async defer></script><script src=/blog/lib/katex/katex.min.js defer></script><script src=/blog/lib/katex/auto-render.min.js defer></script><script src=/blog/lib/katex/mhchem.min.js defer></script><script src=/blog/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/blog/js/codeblock.js defer></script><script src=https://libs.baidu.com/jquery/2.1.4/jquery.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/blog/search.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},version:"v0.3.17-30a67c4b"}</script><script src=/blog/js/theme.min.js defer></script></body></html>